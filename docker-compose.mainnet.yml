# docker-compose.mainnet.yml for Dokploy deployment (BSC Mainnet)
# Service names use -mainnet suffix to avoid DNS conflicts with testnet on dokploy-network
version: "3.8"

services:
  agent-runner-mainnet:
    container_name: agent-runner-mainnet
    image: ghcr.io/kledx/shll-runner:latest
    pull_policy: always
    restart: unless-stopped
    environment:
      # ─── Chain ───
      - RPC_URL=${RPC_URL}
      - RPC_TIMEOUT_MS=${RPC_TIMEOUT_MS:-30000}
      - RPC_RETRY_COUNT=${RPC_RETRY_COUNT:-3}
      - CHAIN_ID=${CHAIN_ID:-56}
      - OPERATOR_PK=${OPERATOR_PK}

      # ─── Contract Addresses ───
      - AGENT_NFA_ADDRESS=${AGENT_NFA_ADDRESS}
      - POLICY_GUARD_ADDRESS=${POLICY_GUARD_ADDRESS}
      - POLICY_GUARD_V4_ADDRESS=${POLICY_GUARD_V4_ADDRESS:-${POLICY_GUARD_ADDRESS}}
      - WBNB_ADDRESS=${WBNB_ADDRESS:-0xbb4CdB9CBd36B01bD1cBaEBF2De08d9173bc095c}
      - DEFI_GUARD=${DEFI_GUARD:-}

      # ─── Token Selection ───
      - TOKEN_ID=${TOKEN_ID}
      - ALLOWED_TOKEN_IDS=${ALLOWED_TOKEN_IDS:-}

      # ─── Runtime ───
      - POLL_INTERVAL_MS=${POLL_INTERVAL_MS:-30000}
      - TOKEN_LOCK_LEASE_MS=${TOKEN_LOCK_LEASE_MS:-90000}
      - MAX_RETRIES=${MAX_RETRIES:-3}
      - LOG_LEVEL=${LOG_LEVEL:-info}

      # ─── LLM Configuration ───
      - LLM_BASE_URL=${LLM_BASE_URL:-}
      - LLM_API_KEY=${LLM_API_KEY:-}
      - LLM_MODEL=${LLM_MODEL:-deepseek-chat}
      - LLM_MAX_TOKENS=${LLM_MAX_TOKENS:-2048}
      - LLM_TIMEOUT_MS=${LLM_TIMEOUT_MS:-30000}

      # ─── Market Signal (optional) ───
      - MARKET_SIGNAL_SYNC_ENABLED=${MARKET_SIGNAL_SYNC_ENABLED:-false}
      - MARKET_SIGNAL_SOURCE_URL=${MARKET_SIGNAL_SOURCE_URL:-}
      - MARKET_SIGNAL_SOURCE_API_KEY=${MARKET_SIGNAL_SOURCE_API_KEY:-}
      - MARKET_SIGNAL_SOURCE_AUTH_HEADER=${MARKET_SIGNAL_SOURCE_AUTH_HEADER:-x-api-key}
      - MARKET_SIGNAL_SOURCE_NAME=${MARKET_SIGNAL_SOURCE_NAME:-source-sync}
      - MARKET_SIGNAL_SYNC_INTERVAL_MS=${MARKET_SIGNAL_SYNC_INTERVAL_MS:-15000}
      - MARKET_SIGNAL_SOURCE_TIMEOUT_MS=${MARKET_SIGNAL_SOURCE_TIMEOUT_MS:-8000}

      # ─── Control API ───
      - API_HOST=${API_HOST:-0.0.0.0}
      - API_PORT=8788
      - API_KEY=${API_KEY:-}

      # ─── PostgreSQL ───
      - DATABASE_URL=${DATABASE_URL:-}
      - PGHOST=${PGHOST:-postgres}
      - PGPORT=${PGPORT:-5432}
      - PGUSER=${PGUSER:-postgres}
      - PGPASSWORD=${PGPASSWORD:-postgres}
      - PGDATABASE=${PGDATABASE:-shll_runner_mainnet}
      - PG_SSL=${PG_SSL:-false}
      - PG_POOL_MAX=${PG_POOL_MAX:-10}

      # ─── Store ───
      - MAX_RUN_RECORDS=${MAX_RUN_RECORDS:-1000}
      - STATUS_RUNS_LIMIT=${STATUS_RUNS_LIMIT:-20}

    ports:
      - "8788:8788"
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"
    networks:
      - dokploy-network

networks:
  dokploy-network:
    external: true
